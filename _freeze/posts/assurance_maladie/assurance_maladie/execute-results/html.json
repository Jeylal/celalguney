{
  "hash": "3210ff009f877752f68c83dec82d134e",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Assurance Maladie\"\nauthor: \"Celâl Güney\"\nformat: html\neditor: visual\nexecute: \n  eval: false\n---\n\n\n::: {.cell}\n\n```{.r .cell-code}\noptions(scipen = 100, digits = 4)\nlibrary(tidyverse)\nlibrary(readr)\nvotation_allegement_prime <- read_delim(\"~/GitHub/celalguney/posts/assurance_maladie/data/votation_allegement_prime.csv\", \n    delim = \";\", escape_double = FALSE, trim_ws = TRUE)\n```\n:::\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(tidyverse)\nlibrary(readr)\n\nvotations2024 <- read_excel(\"votations2024.xlsx\", \n    col_types = c(\"numeric\", \"text\", \"numeric\", \n        \"numeric\"))\n\nafc_chiffrescles_2022 <- read_excel(\"afc_chiffrescles_2022.xlsx\", \n    sheet = \"Gemeinden - Communes\")\n\n\ndata = votations2024 %>% \n  left_join(afc_chiffrescles_2022, by = c(\"Gemeindenummer\" = \"Gemeindenummer\\r\\nCode commune\"))\n\ndata %>% \n  ggplot()+\n  aes(x = decile_mean_reinka, y = freincouts_oui, group = decile_mean_reinka) %>% \n  geom_boxplot()\n\ndata %>% \n  ggplot(aes(x = perc_mean_reinka, y = freincouts_oui)) +\n  geom_point()\n\ndata %>% \n  ggplot(aes(x = gini_reinka, y = freincouts_oui, group = `Kanton\\r\\nCanton`)) +\n  geom_point()+\n  facet_wrap(~`Kanton\\r\\nCanton`)\n\ndata = data %>% \n  mutate(\n    decile_mean_reinka = ntile(mean_reinka, 10),\n    perc_mean_reinka = ntile(mean_reinka, 100)\n  )\n```\n:::\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(BFS)\nlibrary(ggplot2)\nlibrary(sf)\nlibrary(mapview)\n\ncommunes_sf <- bfs_get_base_maps(geom = \"polg\", date = \"20240101\")\ncommunes_sf$id = as.numeric(communes_sf$id)\ndatamap = data %>% \n  left_join(communes_sf, by = c(\"Gemeindenummer\" = \"id\"))\n\n\ndatamap2 = efas_votation_commune[, c(1, 3, 4, 13)] %>% \n  left_join(datamap, by = c(\"No commune\" = \"Gemeindenummer\")) %>% \n  rename(\"efas_oui\" = `Oui en %`)\n\ndatamap %>% \n  ggplot()+ \n  geom_sf(aes(geometry = geometry, fill = allegement_primes_oui))+\n  theme_void()+\n  scale_fill_viridis_b()+\n  theme(legend.position = \"bottom\") \n\ndatamap2 %>% \n  ggplot()+ \n  geom_sf(aes(geometry = geometry, fill = efas_oui))+\n  theme_void()+\n  scale_fill_viridis_c(option = \"turbo\", direction = -1)+\n  theme(legend.position = \"bottom\") \n\n\nlibrary(biscale)\n\nbiclass = bi_class(datamap2, x = median_reinka, y = efas_oui, style = \"quantile\", dim = 3, na_rm = TRUE)\n\nbimap = \nggplot() +\n  geom_sf(data = biclass, mapping = aes(geometry = geometry, fill = bi_class), color = \"white\", size = 0.1, show.legend = F) +\n  bi_scale_fill(pal = \"GrPink\", dim = 3) +\n  bi_theme(base_size = 10)+\n  labs(\n    title = \"Votation sur le financement uniforme des prestations de santé\",\n    caption = \" Pour chaque commune, le pourcentage de oui à la votation de novembre 2024 \n    sur l'uniformation du financement des prestations de santé.\n    Le revenu médian correspond à la médiane du revenu équivalent net en 2022 (en franc). Source: OFS\"\n  )\n\nlegend <- bi_legend(pal = \"GrPink\",\n                    dim = 3,\n                    xlab = \"Revenu médian\",\n                    ylab = \"Oui en %\",\n                    size = 8)\nlibrary(cowplot)\n\nggdraw() +\n  draw_plot(bimap, 0, 0, 1, 1) +\n  draw_plot(legend, 0.05, .65, 0.2, 0.2)\n```\n:::\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nvotation_allegement_prime = votation_allegement_prime %>% \n  mutate(\n    freincouts_oui = if_else(VOTE1 == 1, 1,\n                             if_else(VOTE1 %in% c(2, 3), 0,\n                                     if_else(VOTE1 == 8, NA, 0))),\n    income = case_when(\n      INCOME == 98 ~ NA,\n      INCOME != 98 ~ INCOME\n    ),\n    \n    gender = case_when(\n      S11 == 1 ~ \"Man\",\n      S11 == 2 ~ \"Woman\",\n      S11 == 8 | 3 ~ NA\n    ),\n    \n    isced6 = case_when(\n    EDUC %in% c(10, 21) ~ 1,            # Primaire\n    EDUC %in% c(22, 31) ~ 2,            # Secondaire I\n    EDUC %in% c(32, 33) ~ 3,            # Secondaire II\n    EDUC == 40 ~ 4,                     # Post-secondaire non tertiaire\n    EDUC %in% c(51, 52) ~ 5,            # Tertiaire (sans doctorat)\n    EDUC == 60 ~ 6,                     # Doctorat\n    EDUC %in% c(97, 98) ~ NA\n  ),\n  \n  lr = if_else(LRSP == 98, NA, LRSP)\n  \n  )\n\n\n\nvotation_allegement_prime %>% \n  count(VALUE3)\n```\n:::\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmodel1 = glm(data = votation_allegement_prime,\n             freincouts_oui ~ income + isced6 + lr,\n             family = binomial(link = \"logit\"))\n\nsummary(model1)\nlibrary(marginaleffects)\nmodel1 %>% \n  plot_predictions(by = c(\"income\"))\n  \n   model1 %>% \n    plot_slopes(variables = \"income\", condition = \"lr\")\n```\n:::\n\n\n## Selects panel 2023\n\n\n::: {.cell}\n\n```{.r .cell-code}\nrm(list=ls())\nlibrary(haven)\nlibrary(tidyverse)\nlibrary(marginaleffects)\nlibrary(sjlabelled)\nlibrary(DIGCLASS)\n\nselects2023panel <- haven::read_sav(\"selects2023panel.sav\") #linux\n\nselects2023panel$isco08 = selects2023panel$W1_ISCO08prof_2dig*100\n\nselects2023panel2 = selects2023panel %>% \n  rename(\n    \"assurance_maladie_franchise_pour\" = W1_f15340f,\n    \"op_limit_immigration\" = W1_f15340b,\n    \"op_funding_childcare\" = W1_f15340c,\n    \"op_protec_env\" = W1_f15340d,\n    'op_state_interv' = W1_f15435,\n    'op_social_expenses' = W1_f15420,\n    'op_eu_integration' = W1_f15425,\n    'op_chances_foreigners' = W1_f15440,\n    'op_gender_equality' = W1_f15475,\n    'op_taxes_high_income' = W1_f15480,\n    'op_traditions' = W1_f15485,\n    'op_min_wage' = W1_f15815,\n    'op_incr_retirementAge' = W1_f15811,\n    'probs_vote_plr' = W1_f14400a,\n    'probs_vote_centre' = W1_f14400j,\n    'probs_vote_ps' = W1_f14400c,\n    'probs_vote_udc' = W1_f14400d,\n    'probs_vote_verts' = W1_f14400e,\n    'probs_vote_vertsliberaux' = W1_f14400f,\n\n  ) %>% \n  mutate(\n    income = case_when(\n  W1_f28910 == 1  ~ (0+2000)/2,\n  W1_f28910 == 2  ~ (2001+3000)/2,\n  W1_f28910 == 3  ~ (3001+4000)/2,\n  W1_f28910 == 4  ~ (4001+5000)/2,\n  W1_f28910 == 5  ~ (5001+6000)/2,\n  W1_f28910 == 6  ~ (6001+7000)/2,\n  W1_f28910 == 7  ~ (7001+8000)/2,\n  W1_f28910 == 8  ~ (8001+9000)/2,\n  W1_f28910 == 9  ~ (9001+10000)/2,\n  W1_f28910 == 10 ~ (10001+11000)/2,\n  W1_f28910 == 11 ~ (11001+12000)/2,\n  W1_f28910 == 12 ~ (12001+13000)/2,\n  W1_f28910 == 13 ~ (13001+14000)/2,\n  W1_f28910 == 14 ~ (14001+15000)/2,\n  W1_f28910 == 15 ~ (15001+16000)/2,\n  W1_f28910 == 16 ~ (16001+17000)/2,\n  W1_f28910 == 17 ~ (17001+18000)/2,\n  W1_f28910 == 18 ~ (18001+19000)/2,\n  W1_f28910 == 19 ~ (19001+20000)/2,\n  W1_f28910 == 20 ~ 20001         \n),\nincome_decile = ntile(income, n = 10),\nincome_adjusted = income/sqrt(W1_hhsize_sample),\nincome_adj_decile = ntile(income_adjusted, n = 10),\n\nlr = if_else(W1_f15200 == 98 | is.na(W1_f15200), NA, W1_f15200),\n\neducation_ISCED = case_when(\n  W1_f21310rec %in% c(1, 2) ~ 1,  # No education, Primary = ISCED 1\n  W1_f21310rec == 3        ~ 2,  # Secondary school = ISCED 2\n  W1_f21310rec %in% c(4,5) ~ 3,  # Basic vocational, apprenticeship = ISCED 3\n  W1_f21310rec %in% c(6,7,8) ~ 4, # Upper secondary specialized, trade, vocational = ISCED 4 \n  W1_f21310rec == 9 ~ 5,  # Matu = ISCED 5\n  W1_f21310rec == 10 ~ 5,  # Higher vocational education with federal diploma = ISCED 5\n  W1_f21310rec == 11 ~ 6,  # College of higher education = ISCED 6\n  W1_f21310rec == 12 ~ 6,  # Uni of applied sciences = ISCED 6 (Bachelor level)\n  W1_f21310rec == 13 ~ 7,  # University / Federal Institute of Technology = ISCED 7 (Master)\n  W1_f21310rec == 14 ~ NA   # other\n),\n\npublic_sector = if_else(W1_f21700 == 2, 1, 0),\ncanton = as_character(W1_canton_sample),\nlangue = relevel(factor(as_character(W1_munilang_sample)), ref = \"German\"),\n\n#isco08_4d = isco08_swap(W1_ISCO08prof_2dig, from = 2, to = 3),\n\nmain_activity = case_when(\n  \n  W1_f21400 %in% c(1, 2, 7) ~ 1, # working\n  W1_f21400 %in% c(3) ~ 2, # in training/education\n  W1_f21400 %in% c(6) ~ 3, # disability\n  W1_f21400 %in% c(4, 8) ~ 4, # no paid work\n  W1_f21400 %in% c(5) ~ 5 # retired\n  \n),\n\nwork_status = case_when(\n  W1_f21500 == 4 ~ 1, # self-employed\n  W1_f21500 %in% c(1, 2, 3) ~ 0, # employee\n  is.na(W1_f21500) ~ 2 # not employed\n),\n\neseg = isco08_to_eseg(isco08, work_status = work_status, main_activity = main_activity, age = W1_age, to_factor = FALSE, type = \"two-digit\", label = FALSE)\n\n)\n\nselects2023panel2$assurance_maladie_franchise_pour = selects2023panel2$assurance_maladie_franchise_pour %>% \n  as.ordered()\n\n\nselects2023panel2 = selects2023panel2 %>% \n  mutate(\n     eseg9 = case_when(\n       eseg %in% c(1.1, 1.2, 1.3, 1.4) ~ \"Managers\",\n       eseg %in% c(2.1, 2.2, 2.3, 2.4, 2.5) ~ \"Professionals\",\n       eseg %in% c(3.1, 3.2, 3.3, 3.4, 3.5) ~ \"Technicians and associated professionals employees\",\n       eseg %in% c(4.1, 4.2, 4.3) ~ \"small entrepreneurs\",\n       eseg %in% c(5.1, 5.2, 5.3, 5.4) ~ \"Clerks and skilled service employees\",\n       eseg %in% c(6.1, 6.2, 6.3, 6.4, 6.5) ~ \"Skilled industrial employees\",\n       eseg %in% c(7.1, 7.2, 7.3, 7.4) ~ \"Lower status employees\",\n       eseg %in% c(8.8) ~ \"Retired\",\n       eseg %in% c(9.1) ~ \"Student\",\n       eseg %in% c(9.2, 9.3) ~ \"Unemployed or disabled\"\n     ),\n     \n     eseg10 = case_when(\n       eseg %in% c(1.1, 1.2, 1.3, 1.4) ~ \"Managers\",\n       eseg %in% c(2.1, 2.2, 2.4, 2.5) ~ \"Professionals\",\n       eseg == 2.3 ~ \"Business and administration professionals\",\n       eseg %in% c(3.1, 3.2, 3.3, 3.4, 3.5) ~ \"Technicians and associated professionals employees\",\n       eseg %in% c(4.1, 4.2, 4.3) ~ \"small entrepreneurs\",\n       eseg %in% c(5.1, 5.2, 5.3, 5.4) ~ \"Clerks and skilled service employees\",\n       eseg %in% c(6.1, 6.2, 6.3, 6.4, 6.5) ~ \"Skilled industrial employees\",\n       eseg %in% c(7.1, 7.2, 7.3, 7.4) ~ \"Lower status employees\",\n       eseg %in% c(8.8) ~ \"Retired\",\n       eseg %in% c(9.1) ~ \"Student\",\n       eseg %in% c(9.2, 9.3) ~ \"Unemployed or disabled\"\n     )\n  )\n\nselects2023panel2 %>% \n  group_by(eseg10) %>% \n  count(assurance_maladie_franchise_pour %in% c(1, 2)) %>% \n  mutate(prop = n/sum(n)) %>% \n  ungroup() %>% \n  filter(`assurance_maladie_franchise_pour %in% c(1, 2)` == TRUE) %>% \n  ggplot(aes(x = prop, y = eseg10))+\n  geom_point()\n```\n:::\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(MASS)\n\nselects2023panel2$eseg10 = relevel(factor(selects2023panel2$eseg10), ref = \"Business and administration professionals\")\n\nsummary(model1 <- polr(data = selects2023panel2,\n           assurance_maladie_franchise_pour ~ eseg10 + canton,\n           Hess = TRUE), method = \"logit\")\n\n\nsummary(model2 <- polr(data = selects2023panel2,\n           assurance_maladie_franchise_pour ~ eseg10 + income_adj_decile*lr + education_ISCED + canton,\n           Hess = TRUE), method = \"logit\")\n\nanova(model1, model2)\n\nlibrary(brms)\n\nmodel2 = brm(\n  data = selects2023panel2,\n  formula = assurance_maladie_franchise_pour ~ eseg10 + (1|canton),\n  family = cumulative(link = 'logit')\n)\n\nsummary(model2)\nlibrary(collapse)\nranefmodel2 = ranef(model2)[\"canton\"]\n```\n:::\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\np = avg_predictions(model2, by = \"eseg10\")\np2 = avg_predictions(model2, by = \"lr\")\n\n\np %>% ggplot()+\n  aes(x = estimate, y = eseg10, color = group)+\n  geom_point()+\n  geom_errorbar(aes(xmin = conf.low, xmax = conf.high))+\n  facet_wrap(~group)\n\np2 %>% \n  ggplot(aes(x = lr, y = estimate, color = group))+\n  geom_line()+\n  geom_ribbon(aes(ymin = conf.low, ymax = conf.high, fill = group), alpha = 0.2)\n```\n:::\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsummary(model3 <- polr(data = selects2023panel2,\n           assurance_maladie_franchise_pour ~ 1 + factor(W1_sex) + income_adj_decile + education_ISCED + lr + probs_vote_udc + probs_vote_plr + probs_vote_ps + probs_vote_centre + op_limit_immigration + op_state_interv + op_social_expenses + op_min_wage + op_incr_retirementAge + op_taxes_high_income + canton,\n           Hess = TRUE), method = \"logit\")\n\nlibrary(gt)\nlibrary(gtsummary)\n\nmodel3 %>% \n  tbl_regression()\n```\n:::\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}